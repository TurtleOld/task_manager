# MikroTik Advanced Backup to Telegram Script
# –ê–≤—Ç–æ—Ä: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
# –û–ø–∏—Å–∞–Ω–∏–µ: –°–æ–∑–¥–∞–µ—Ç backup –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

# ========================================
# –ù–ê–°–¢–†–û–ô–ö–ò TELEGRAM
# ========================================
:local botToken "YOUR_BOT_TOKEN_HERE"
:local chatId "YOUR_CHAT_ID_HERE"

# ========================================
# –û–°–ù–û–í–ù–û–ô –°–ö–†–ò–ü–¢
# ========================================

# –ü–æ–ª—É—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
:local name [/system identity get name];
:local tmpdate [/system clock get date];
:local time [/system clock get time];
:local date ([:pick $tmpdate 8 10]."-".[:pick $tmpdate 5 7]."-".[:pick $tmpdate 0 4]);

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
:local uptime [/system resource get uptime];
:local version [/system resource get version];
:local cpuLoad [/system resource get cpu-load];
:local freeMemory [/system resource get free-memory];
:local totalMemory [/system resource get total-memory];
:local memoryUsage (100 - (($freeMemory * 100) / $totalMemory));

# –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
:local myname "Mikrotik";
:local fname ($myname."_".$date);
:local bname ($myname."_".$date.".backup");

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
:local startMessage ("üîÑ Starting backup process for ".$name."\n".
    "üìÖ Date: ".$date."\n".
    "‚è∞ Time: ".$time."\n".
    "üñ•Ô∏è Version: ".$version."\n".
    "‚è±Ô∏è Uptime: ".$uptime."\n".
    "üíæ Memory Usage: ".[:round $memoryUsage 1]."%\n".
    "üñ•Ô∏è CPU Load: ".$cpuLoad."%");

/tool fetch url=("https://api.telegram.org/bot".$botToken."/sendMessage") \
    http-method=post \
    http-data=("chat_id=".$chatId."&text=".$startMessage."&parse_mode=HTML") \
    mode=https;

:log info "Starting to create a backup";

# –°–æ–∑–¥–∞–µ–º backup
/system backup save name=$fname;
:log info "Backup created successfully";

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞
:delay 5;

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–ª—Å—è
:local fileExists [/file find name=$bname];
:if ([:len $fileExists] = 0) do={
    :local errorMessage ("‚ùå Error: Backup file not found for ".$name." at ".$date." ".$time);
    /tool fetch url=("https://api.telegram.org/bot".$botToken."/sendMessage") \
        http-method=post \
        http-data=("chat_id=".$chatId."&text=".$errorMessage."&parse_mode=HTML") \
        mode=https;
    :log error "Backup file not found";
    :error "Backup file not found";
}

# –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
:local fileInfo [/file print where name=$bname];
:local fileSize [:pick $fileInfo 0 [:find $fileInfo "size="]];
:local size [:pick $fileSize ([:find $fileSize "size="] + 5) [:len $fileSize]];

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º backup –≤ Telegram
:log info "Sending backup to Telegram";
/tool fetch url=("https://api.telegram.org/bot".$botToken."/sendDocument") \
    http-method=post \
    http-data=("chat_id=".$chatId."&document=@".$fname.".backup&caption=üìÅ Backup ".$name." ".$date." ".$time."\nüìè Size: ".$size." bytes") \
    mode=https;

# –ñ–¥–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏
:delay 3;

# –£–¥–∞–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª backup
/file remove $bname;
:log info "Local backup file removed";

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
:local successMessage ("‚úÖ Backup completed successfully!\n".
    "üì± Device: ".$name."\n".
    "üìÖ Date: ".$date."\n".
    "‚è∞ Time: ".$time."\n".
    "üìè File Size: ".$size." bytes\n".
    "üñ•Ô∏è CPU Load: ".$cpuLoad."%\n".
    "üíæ Memory Usage: ".[:round $memoryUsage 1]."%");

/tool fetch url=("https://api.telegram.org/bot".$botToken."/sendMessage") \
    http-method=post \
    http-data=("chat_id=".$chatId."&text=".$successMessage."&parse_mode=HTML") \
    mode=https;

:log info "Backup process completed successfully";