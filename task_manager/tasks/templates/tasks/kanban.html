{% extends '../base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}

{% block title %}{% translate 'Список задач' %}{% endblock %}

{% block content %}
<div x-data="kanbanBoard" x-init="init()" class="container kanban-negative-margin" data-tasks='{{ tasks|safe }}'>
    <a href="{% url 'tasks:create' %}" class="button is-primary is-large has-text-weight-bold mb-1 kanban-create-btn">
        <span class="icon"><i class="fas fa-plus"></i></span>
        <span>Создать задачу</span>
    </a>
    <div class="columns is-multiline">
        {% for stage in stages %}
            <div class="column is-one-quarter is-full-mobile" data-stage-id="{{ stage.id }}">
                <div class="box kanban-box">
                    <div
                        class="kanban-column"
                        @dragover.prevent="onDragOver($event, {{ stage.id }})"
                        @dragleave="onDragLeave($event, {{ stage.id }})"
                        @drop="drop($event, {{ stage.id }})"
                        :class="dragOverStage == {{ stage.id }} ? 'is-dragover' : ''"
                    >
                        <div class="kanban-header">
                            <h2 class="subtitle is-4 has-text-weight-bold">
                                <span class="icon is-small mr-1"><i class="fas fa-layer-group"></i></span>
                                {{ stage.name }}
                                <span class="tag is-light ml-2" x-text="tasks['{{ stage.id }}']?.length || 0"></span>
                            </h2>
                        </div>
                        <template x-for="(task, idx) in tasks['{{ stage.id }}']" :key="task.id ? task.id : 'placeholder-' + idx">
                            <div>
                                <div x-show="task.placeholder" class="kanban-placeholder"></div>
                                {% include 'tasks/_task_card.html' %}
                            </div>
                        </template>
                        {% include 'tasks/_empty_column_message.html' with stage_id=stage.id %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    <div x-show="showDeleteModal" class="modal is-active fade-in" style="z-index: 1000;" aria-modal="true" role="dialog" aria-labelledby="deleteModalTitle">
      <div class="modal-background" @click="closeDeleteModal"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title" id="deleteModalTitle">Подтверждение удаления</p>
          <button class="delete" aria-label="close" @click="closeDeleteModal"></button>
        </header>
        <section class="modal-card-body">
          <p>Вы уверены, что хотите удалить задачу <b x-text="deleteTaskObj && deleteTaskObj.name"></b>?</p>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-danger" @click="confirmDelete(deleteTaskObj)" id="confirmDeleteBtn">Да, удалить</button>
          <button class="button" @click="closeDeleteModal">Отмена</button>
        </footer>
      </div>
    </div>
</div>

{% endblock %}