{% extends '../base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}

{% block title %}{% translate 'Список задач' %}{% endblock %}

{% block content %}
<main x-data="kanbanBoard" x-init="init()" class="container" data-tasks='{{ tasks|safe }}' role="main" aria-label="{% translate 'Доска задач' %}">
    <!-- Mobile Instructions -->
    <div class="notification is-info is-light is-hidden-desktop mb-4" x-show="isMobile">
        <div class="content">
            <h4 class="title is-6">
                <span class="icon-text">
                    <span class="icon">
                        <i class="fas fa-mobile-alt"></i>
                    </span>
                    <span>Мобильная версия</span>
                </span>
            </h4>
            <p>Для перемещения карточек на мобильном устройстве:</p>
            <ol>
                <li>Нажмите и удерживайте карточку</li>
                <li>Перетащите её в нужную колонку</li>
                <li>Отпустите для завершения перемещения</li>
            </ol>
        </div>
    </div>

    <header class="mb-5 mt-5">
        <div class="columns is-multiline is-align-items-center">
            <div class="column is-narrow">
                <a href="{% url 'tasks:create' %}" 
                   class="button has-background-primary is-large has-text-weight-bold is-rounded"
                   aria-label="{% translate 'Создать новую задачу' %}"
                   title="{% translate 'Создать новую задачу' %}">
                    <span class="icon" aria-hidden="true"><i class="fas fa-plus"></i></span>
                    <span>{% translate 'Создать задачу' %}</span>
                </a>
            </div>
            
            <!-- Filter Section -->
            <div class="column">
                <div class="kanban-filters">
                    <div class="filter-header">
                        <h3 class="title is-5">
                            <i class="fas fa-filter"></i>
                            {% translate 'Фильтр по тегам' %}
                        </h3>
                    </div>
                    
                    <form method="get" class="filter-form" id="labelFilterForm">
                        <div class="filter-tags">
                            {% for label in labels %}
                            <label class="filter-tag-checkbox">
                                <input type="checkbox" 
                                       name="labels" 
                                       value="{{ label.id }}"
                                       {% if label.id|stringformat:"s" in selected_labels %}checked{% endif %}
                                       class="filter-checkbox">
                                <span class="filter-tag">
                                    <i class="fas fa-tag"></i>
                                    {{ label.name }}
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                        
                        <div class="filter-actions">
                            <button type="submit" class="button is-info is-small">
                                <i class="fas fa-search"></i>
                                {% translate 'Применить фильтр' %}
                            </button>
                            <a href="{% url 'tasks:list' %}" class="button is-light is-small">
                                <i class="fas fa-times"></i>
                                {% translate 'Сбросить' %}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </header>
    
    <section class="columns is-multiline is-gapless" role="region" aria-label="{% translate 'Колонки задач' %}">
        {% for stage in stages %}
            <article class="column is-one-quarter is-full-mobile" 
                     data-stage-id="{{ stage.id }}"
                     role="region" 
                     aria-label="{% translate 'Колонка' %}: {{ stage.name }}">
                <div class="box has-background-white-ter has-shadow">
                    <div
                        class="has-background-white has-radius-large p-4"
                        @dragover.prevent="onDragOver($event, {{ stage.id }})"
                        @dragleave="onDragLeave($event, {{ stage.id }})"
                        @drop="drop($event, {{ stage.id }})"
                        :class="dragOverStage == {{ stage.id }} ? 'has-background-primary-light' : ''"
                        role="list"
                        aria-label="{% translate 'Список задач в колонке' %}: {{ stage.name }}"
                        :aria-describedby="'stage-count-{{ stage.id }}'"
                        class="task-list-container"
                    >
                        <header class="has-background-primary has-text-white has-radius-large p-3 mb-4">
                            <h2 class="title is-5 has-text-white has-text-weight-bold is-flex is-align-items-center is-justify-content-space-between">
                                <span class="is-flex is-align-items-center">
                                    <span class="icon is-small mr-2" aria-hidden="true">
                                        <i class="fas fa-layer-group"></i>
                                    </span>
                                    <span class="stage-name">{{ stage.name }}</span>
                                </span>
                                <span class="tag is-white is-rounded has-text-primary has-text-weight-bold" 
                                      x-text="tasks['{{ stage.id }}']?.length || 0"
                                      id="stage-count-{{ stage.id }}"
                                      aria-label="{% translate 'Количество задач' %}: "
                                      :aria-label="`{% translate 'Количество задач' %}: ${tasks['{{ stage.id }}']?.length || 0}`">
                                </span>
                            </h2>
                        </header>
                        
                        <div class="task-list">
                            <template x-for="(task, idx) in tasks['{{ stage.id }}']" :key="task.id ? task.id : 'placeholder-' + idx">
                                <div role="listitem" class="mb-1">
                                    <div x-show="task.placeholder" class="has-background-light has-radius-large p-4 has-text-centered has-text-grey-light" aria-hidden="true">
                                        <span class="icon is-large">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </span>
                                    </div>
                                    {% include 'tasks/_task_card.html' %}
                                </div>
                            </template>
                            
                            {% include 'tasks/_empty_column_message.html' with stage_id=stage.id %}
                        </div>
                    </div>
                </div>
            </article>
        {% endfor %}
    </section>
    
    <div x-show="showDeleteModal" 
         class="modal is-active delete-modal" 
         aria-modal="true" 
         role="dialog" 
         aria-labelledby="deleteModalTitle"
         aria-describedby="deleteModalDescription">
        <div class="modal-background" @click="closeDeleteModal" aria-label="{% translate 'Закрыть модальное окно' %}"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title" id="deleteModalTitle">{% translate 'Подтверждение удаления' %}</p>
                <button class="delete" 
                        aria-label="{% translate 'Закрыть' %}" 
                        @click="closeDeleteModal"
                        @keydown.escape="closeDeleteModal">
                </button>
            </header>
            <section class="modal-card-body">
                <p id="deleteModalDescription">
                    {% translate 'Вы уверены, что хотите удалить задачу' %} 
                    <strong x-text="deleteTaskObj && deleteTaskObj.name"></strong>?
                </p>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-danger" 
                        @click="confirmDelete(deleteTaskObj)" 
                        id="confirmDeleteBtn"
                        aria-label="{% translate 'Подтвердить удаление задачи' %}">
                    {% translate 'Да, удалить' %}
                </button>
                <button class="button" 
                        @click="closeDeleteModal"
                        aria-label="{% translate 'Отменить удаление' %}">
                    {% translate 'Отмена' %}
                </button>
            </footer>
        </div>
    </div>
</main>
{% endblock %}