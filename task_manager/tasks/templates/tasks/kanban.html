{% extends '../base.html' %}
{% load bootstrap4 %}
{% load i18n %}

{% block content %}
<div class="row">
    <div class="col-1">
        <a class="btn btn-outline-primary mb-1" href="{% url 'tasks:create_stage' %}">Создать колонку</a>
        <a class="btn btn-outline-primary" href="{% url 'tasks:create' %}">Создать задачу</a>
    </div>
        <div class="col-10 d-flex justify-content-around">
            {% for stage in stages %}
                <div class="stage" data-stage-id="{{ stage.pk }}">
                    <h5 class="border text-center ps-5 pe-5 pt-1 pb-1" >{{ stage.name }}</h5>
                    <ul id="stage-{{ stage.pk }}" class="task-list">
                        <!-- Цикл по задачам -->
                        {% for task in stage.tasks.all %}
                            <li data-task-id="{{ task.pk }}" data-old-stage-id="{{ stage.pk }}">{{ task.name }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endfor %}
        </div>
</div>

<script>
    document.querySelectorAll('.task-list').forEach(function(list) {
        new Sortable(list, {
            group: 'tasks',
            animation: 150,
            onEnd: function(evt) {
                const itemEl = evt.item;
                const newStageContainer = itemEl.closest('.stage');
                const newStageId = newStageContainer.getAttribute('data-stage-id');
                const oldStageId = itemEl.getAttribute('data-old-stage-id');
                itemEl.setAttribute('data-old-stage-id', newStageId);
                const tasks = Array.from(itemEl.parentNode.children).map((li, index) => ({
                    task_id: li.getAttribute('data-task-id'),
                    stage_id: li.getAttribute('data-old-stage-id') || newStageId,
                    order: index + 1
                }));

                fetch("{% url 'tasks:update_task_order' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ tasks: tasks })
                })
            }
        });
    });
</script>
{% endblock %}