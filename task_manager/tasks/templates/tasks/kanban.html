{% extends '../base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}

{% block title %}{% translate 'Список задач' %}{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="title">Kanban Board</h1>
    <a href="{% url 'tasks:create' %}" class="button is-primary mb-1">Создать задачу</a>
    <!-- /.button is-primary -->
    <div class="columns is-multiline">
        {% for stage in stages %}
        <div class="column is-one-quarter" data-stage-id="{{ stage.id }}">
            <div class="box kanban-box">
                <div
                    class="kanban-column"
                    @dragover="onDragOver($event)"
                    @drop="drop($event, {{ stage.id }})"
                >
                    <div class="kanban-header">
                        <h2 class="subtitle">{{ stage.name }}</h2>
                    </div>
                    {% if not stage.tasks.all %}
                        <p class="has-text-centered has-text-grey-light empty-message">Пусто</p>
                    {% endif %}
                    {% for task in stage.tasks.all %}
                    <div
                        class="box mb-2 kanban-task"
                        draggable="true"
                        @dragstart="window.dragging = {{ task.id }}"
                        @dragend="window.dragging = null"
                        data-task-id="{{ task.id }}"
                    >
                        <div class="is-flex is-justify-content-space-between">
                            <p>{{ task.name }}</p>
                            <button
                                class="delete-task button is-small is-danger"
                                data-task-id="{{ task.id }}"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
                                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                  <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function onDragOver(event) {
        event.preventDefault();
    }
</script>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    const updateTaskStageUrl = "{% url 'tasks:update_task_stage' %}";

    // AJAX для перемещения задачи
    function drop(event, newStageId) {
        const taskId = window.dragging;
        if (!taskId) {
            return;
        }

        fetch(updateTaskStageUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                task_id: taskId,
                new_stage_id: newStageId,
            }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    const column = event.target.closest('.kanban-column');
                    if (column) {
                        const emptyMessage = column.querySelector('.empty-message');
                        if (emptyMessage) {
                            emptyMessage.remove();
                        }

                        column.appendChild(taskElement);
                    } else {
                        console.error('Drop target is not a valid column');
                    }
                } else {
                    console.error('Task element not found');
                }
            } else {
                console.error('Server error:', data.error);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
        });
    }

    document.addEventListener('alpine:init', () => {
        window.dragging = null;
    });
</script>
<script>
    const deleteTaskBaseUrl = "{{ delete_task_base_url }}";

    // AJAX для удаления задачи
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.delete-task').forEach(button => {
            button.addEventListener('click', (event) => {
                event.preventDefault();

                const taskId = button.dataset.taskId;
                const taskElement = button.closest('.kanban-task');
                const deleteTaskUrl = `${deleteTaskBaseUrl}/${taskId}/`;

                fetch(deleteTaskUrl, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        taskElement.remove();
                        console.log(data.message);
                    } else {
                        console.error(data.error);
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                });
            });
        });
    });
</script>
{% endblock %}