{% load i18n %}

<article
    class="box has-shadow has-radius-large is-clickable kanban-task-card"
    :data-task-id="task.id"
    :data-status="task.status"
    draggable="true"
    @dragstart="dragStart(task.id)"
    @dragend="dragEnd"
    @click="dropdownTaskId = null"
    :class="{
        'is-dragging': dragging == task.id,
        'is-selected': selectedTask == task.id,
        'has-background-primary-light': false
    }"
    :aria-label="`Задача: ${task.name}`"
    @keydown.enter="window.location.href = `/tasks/${task.slug}`"
    @keydown.space.prevent="window.location.href = `/tasks/${task.slug}`"
>
    <div class="is-flex is-justify-content-space-between is-align-items-flex-start">
        <a :href="`/tasks/${task.slug}`" 
           class="is-flex-grow-1"
           @click.stop
           :aria-label="`Открыть задачу: ${task.name}`"
           title="{% translate 'Открыть задачу' %}">
            <header class="is-flex is-align-items-center mb-3">
                <figure class="image is-32x32 mr-3" :title="task.executor?.full_name || '{% translate 'Исполнитель не назначен' %}'">
                    <template x-if="task.executor?.avatar">
                        <img :src="task.executor.avatar" 
                             :alt="`Аватар исполнителя: ${task.executor.full_name}`"
                             class="is-rounded">
                    </template>
                    <template x-if="!task.executor?.avatar">
                        <div class="has-background-primary has-text-white is-rounded has-text-centered has-text-weight-bold"
                             style="width: 32px; height: 32px; line-height: 32px;"
                             :aria-label="`Исполнитель: ${task.executor?.full_name || 'Не назначен'}`">
                            <span x-text="task.executor?.full_name ? task.executor.full_name[0] : '?'" />
                        </div>
                    </template>
                </figure>
                <h3 class="title is-5 has-text-weight-bold"
                    :class="task.status == 'done' ? 'has-text-success' : 'has-text-primary'"
                    x-text="task.name"
                    lang="ru">
                </h3>
            </header>
            
            <div class="mb-3 is-flex is-align-items-center is-flex-wrap-wrap">
                <span class="tag is-light is-small mr-2 mb-1" 
                      :title="`Автор: ${task.author?.full_name}`"
                      :aria-label="`Автор задачи: ${task.author?.full_name}`">
                    <span class="icon is-small mr-1" aria-hidden="true">
                        <i class="fas fa-user"></i>
                    </span>
                    <span x-text="task.author?.full_name"></span>
                </span>
                <span class="tag is-primary is-light is-small mr-2"
                      :title="`Исполнитель: ${task.executor?.full_name || 'Не назначен'}`"
                      :aria-label="`Исполнитель задачи: ${task.executor?.full_name || 'Не назначен'}`">
                    <span class="icon is-small mr-1" aria-hidden="true">
                        <i class="fas fa-user-check"></i>
                    </span>
                    <span x-text="task.executor?.full_name || '{% translate 'Не назначен' %}'"></span>
                </span>
                <span class="tag is-warning is-light is-small mr-2" 
                      title="{% translate 'Приоритет' %}" 
                      x-show="task.priority"
                      :aria-label="`Приоритет: ${task.priority}`">
                    <span class="icon is-small mr-1" aria-hidden="true">
                        <i class="fas fa-flag"></i>
                    </span>
                    <span x-text="task.priority"></span>
                </span>
                <span class="tag is-info is-light is-small" 
                      title="{% translate 'Дедлайн' %}" 
                      x-show="task.deadline"
                      :aria-label="`Дедлайн: ${task.deadline}`">
                    <span class="icon is-small mr-1" aria-hidden="true">
                        <i class="fas fa-clock"></i>
                    </span>
                    <span x-text="task.deadline"></span>
                </span>
            </div>
            
            <!-- Task Labels -->
            <div class="mb-3" x-show="task.labels && task.labels.length > 0">
                <div class="task-card-labels">
                    <template x-for="label in task.labels" :key="label.id">
                        <span class="task-card-tag"
                              :title="`Тег: ${label.name}`"
                              :aria-label="`Тег: ${label.name}`">
                            <i class="fas fa-tag"></i>
                            <span x-text="label.name"></span>
                        </span>
                    </template>
                </div>
            </div>
            
            <footer class="has-text-grey-light">
                <small>{% translate 'Создана' %}: <time x-text="task.created_at"></time></small>
            </footer>
        </a>
        
        <nav class="dropdown" 
             :class="{ 'is-active': dropdownTaskId === task.id }"
             role="navigation"
             :aria-label="`Действия для задачи: ${task.name}`">
            <div class="dropdown-trigger">
                <button class="button is-small is-light" 
                        @click.stop="toggleDropdown(task.id, $event)" 
                        :title="`{% translate 'Действия для задачи' %}: ${task.name}`"
                        :aria-label="`{% translate 'Действия для задачи' %}: ${task.name}`"
                        :aria-expanded="dropdownTaskId === task.id"
                        @keydown.escape="dropdownTaskId = null"
                        @click.stop>
                    <span class="icon is-small" aria-hidden="true">
                        <i class="fas fa-ellipsis-v"></i>
                    </span>
                </button>
            </div>
            <div class="dropdown-menu" role="menu" @click.stop>
                <div class="dropdown-content">
                    <a :href="`/tasks/${task.slug}`" 
                       class="dropdown-item" 
                       @click="dropdownTaskId = null"
                       :title="`{% translate 'Посмотреть задачу' %}: ${task.name}`"
                       :aria-label="`{% translate 'Посмотреть задачу' %}: ${task.name}`">
                        <span class="icon is-small mr-2" aria-hidden="true">
                            <i class="fas fa-eye"></i>
                        </span>
                        {% translate 'Посмотреть' %}
                    </a>
                    <a :href="`/tasks/update/${task.slug}/`" 
                       class="dropdown-item" 
                       @click="dropdownTaskId = null"
                       :title="`{% translate 'Редактировать задачу' %}: ${task.name}`"
                       :aria-label="`{% translate 'Редактировать задачу' %}: ${task.name}`">
                        <span class="icon is-small mr-2" aria-hidden="true">
                            <i class="fas fa-edit"></i>
                        </span>
                        {% translate 'Редактировать' %}
                    </a>
                    <hr class="dropdown-divider">
                    <button class="dropdown-item has-text-danger" 
                            @click.prevent="openDeleteModal(task); dropdownTaskId = null" 
                            :title="`{% translate 'Удалить задачу' %}: ${task.name}`"
                            :aria-label="`{% translate 'Удалить задачу' %}: ${task.name}`">
                        <span class="icon is-small mr-2" aria-hidden="true">
                            <i class="fas fa-trash"></i>
                        </span>
                        {% translate 'Удалить' %}
                    </button>
                </div>
            </div>
        </nav>
    </div>
</article> 