{% extends '../base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}
{% load static %}

{% block title %}{{ task.name }}{% endblock %}

{% block content %}
    <div class="task-detail-card">
        <div class="task-detail-header">
            <h1 class="task-detail-title">
                <i class="fa fa-tasks"></i>
                {{ task.name }}
                {% if task.state == 'done' %}
                    <span class="task-status-tag success">
                        <i class="fa fa-check"></i> Выполнена
                    </span>
                {% elif task.deadline and task.deadline < now %}
                    <span class="task-status-tag danger">
                        <i class="fa fa-exclamation-triangle"></i> Просрочена
                    </span>
                {% endif %}
            </h1>
            <div class="task-description-container">
                <p class="task-detail-description" id="task-description">
                    <span class="description-short">{{ task.description|truncatechars:100 }}</span>
                    <span class="description-full" style="display: none;">{{ task.description }}</span>
                </p>
                {% if task.description|length > 100 %}
                    <button class="description-toggle-btn" id="description-toggle">
                        <i class="fa fa-chevron-down"></i>
                        <span class="toggle-text">Показать больше</span>
                    </button>
                {% endif %}
            </div>
        </div>
        
        <div class="task-detail-content">
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-user"></i>
                    {% translate 'Автор' %}
                </div>
                <div class="task-info-value">{{ task.author }}</div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-user-check"></i>
                    {% translate 'Исполнитель' %}
                </div>
                <div class="task-info-value">{{ task.executor }}</div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-tags"></i>
                    {% translate 'Теги' %}
                </div>
                <div class="task-info-value">
                    {% if task.labels.all %}
                        <div class="task-tags">
                            {% for label in task.labels.all %}
                                <span class="task-tag">
                                    <i class="fa fa-tag"></i>
                                    {{ label.name }}
                                </span>
                            {% endfor %}
                        </div>
                    {% else %}
                        <span class="has-text-grey">{% translate 'Теги не назначены' %}</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-bell"></i>
                    {% translate 'Напоминание до' %}
                </div>
                <div class="task-info-value">
                    {% if task.reminder_periods.all %}
                        {% for period in task.reminder_periods.all %}
                            <span class="tag is-info is-light">{{ period }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="has-text-grey">Напоминания не установлены</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-paperclip"></i>
                    {% translate 'Приложенные файлы' %}
                </div>
                <div class="task-info-value">
                    {% if task.image and task.image.url != '' %}
                        <div class="task-file-section">
                            <div class="task-file-preview">
                                <img src="{{ task.image.url }}" alt="Превью файла" style="max-width: 80px; max-height: 60px; display: block;">
                            </div>
                            <div class="task-file-actions">
                                <a class="button is-small is-primary" href="{% url 'tasks:download' task.slug %}" download>
                                    <i class="fa fa-download"></i> Скачать
                                </a>
                                <button id="preview-image-button" class="button is-small is-info">
                                    <i class="fa fa-image"></i> Просмотр
                                </button>
                            </div>
                        </div>
                        <div id="image-modal" class="modal">
                            <div class="modal-background"></div>
                            <div class="modal-content has-text-centered">
                                <a id="link-image" href="" target="_blank">
                                    <img src="{{ task.image.url }}" width="350" height="300" id="preview-image" class="mt-1" src="" alt="Preview" />
                                </a>
                            </div>
                            <button class="modal-close is-large" aria-label="close"></button>
                        </div>
                    {% else %}
                        <span class="has-text-grey">Нет файлов</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-calendar"></i>
                    {% translate 'Дата' %}
                </div>
                <div class="task-info-value">
                    {% if task.deadline %}
                        <span class="tag is-warning is-light">{{ task.deadline|date:"d.m.Y H:i" }}</span>
                    {% else %}
                        <span class="has-text-grey">Бессрочно</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-tasks"></i>
                    {% translate 'Чек-лист' %}
                </div>
                <div class="task-info-value">
                    {% if checklist_items %}
                        {% if total_checklist > 0 %}
                            <div class="checklist-progress-container" id="checklist-progress-block" hx-get="{% url 'tasks:checklist_progress' task.pk %}" hx-trigger="load, checklist-updated from:body">
                                <div class="checklist-progress-bar">
                                    <div class="checklist-progress-fill" style="width: {{ progress_checklist }}%"></div>
                                </div>
                                <div class="checklist-progress-text">{{ done_checklist }} / {{ total_checklist }} выполнено</div>
                            </div>
                        {% endif %}
                        <ul class="list-group">
                            {% for item in checklist_items %}
                                {% include 'tasks/checklist_item.html' with item=item %}
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="has-text-grey">Чеклист пуст.</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-calendar-plus"></i>
                    {% translate 'Дата создания' %}
                </div>
                <div class="task-info-value">
                    <span class="tag is-light">{{ task.created_at|date:'d.m.Y H:i' }}</span>
                </div>
            </div>
            
            <div class="task-action-buttons">
                <a class="task-action-button primary" href="{% url 'tasks:list' %}">
                    <i class="fa fa-list"></i>
                    Список задач
                </a>
                <a class="task-action-button warning {% if task.state == 'done' %}disabled{% endif %}" href="{% url 'tasks:update' task.slug %}">
                    <i class="fa fa-edit"></i>
                    Изменить
                </a>
                <a class="task-action-button danger" href="{% url 'tasks:delete_task' task.slug %}">
                    <i class="fa fa-trash"></i>
                    Удалить
                </a>
            </div>
        </div>
    </div>
    

{% endblock %}
    
