{% extends '../base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}
{% load static %}

{% block title %}{{ task.name }}{% endblock %}

{% block content %}
    <div class="task-detail-card">
        <div class="task-detail-header">
            <h1 class="task-detail-title">
                <i class="fa fa-tasks"></i>
                {{ task.name }}
                {% if task.state == 'done' %}
                    <span class="task-status-tag success">
                        <i class="fa fa-check"></i> Выполнена
                    </span>
                {% elif task.deadline and task.deadline < now %}
                    <span class="task-status-tag danger">
                        <i class="fa fa-exclamation-triangle"></i> Просрочена
                    </span>
                {% endif %}
            </h1>
            <div class="task-description-container">
                <p class="task-detail-description" id="task-description">
                    <span class="description-short">{{ task.description|truncatechars:100|linebreaks }}</span>
                    <span class="description-full">{{ task.description|linebreaks }}</span>
                </p>
                {% if task.description|length > 100 %}
                    <button class="description-toggle-btn" id="description-toggle">
                        <i class="fa fa-chevron-down"></i>
                        <span class="toggle-text">Показать больше</span>
                    </button>
                {% endif %}
            </div>
        </div>
        
        <div class="task-detail-content">
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-user"></i>
                    {% translate 'Автор' %}
                </div>
                <div class="task-info-value">{{ task.author }}</div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-user-check"></i>
                    {% translate 'Исполнитель' %}
                </div>
                <div class="task-info-value">{{ task.executor }}</div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-tags"></i>
                    {% translate 'Теги' %}
                </div>
                <div class="task-info-value">
                    {% if task.labels.all %}
                        <div class="task-tags">
                            {% for label in task.labels.all %}
                                <span class="task-tag">
                                    <i class="fa fa-tag"></i>
                                    {{ label.name }}
                                </span>
                            {% endfor %}
                        </div>
                    {% else %}
                        <span class="has-text-grey">{% translate 'Теги не назначены' %}</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-bell"></i>
                    {% translate 'Напоминание до' %}
                </div>
                <div class="task-info-value">
                    {% if task.reminder_periods.all %}
                        {% for period in task.reminder_periods.all %}
                            <span class="tag is-info is-light">{{ period }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="has-text-grey">Напоминания не установлены</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-paperclip"></i>
                    {% translate 'Приложенные файлы' %}
                </div>
                <div class="task-info-value">
                    {% if task.image and task.image.url != '' %}
                        <div class="task-file-section">
                            <div class="task-file-preview">
                                <img src="{{ task.image.url }}" alt="Превью файла">
                            </div>
                            <div class="task-file-actions">
                                <a class="button is-small is-primary" href="{% url 'tasks:download' task.slug %}" download>
                                    <i class="fa fa-download"></i> Скачать
                                </a>
                                <button id="preview-image-button" class="button is-small is-info">
                                    <i class="fa fa-image"></i> Просмотр
                                </button>
                            </div>
                        </div>
                        <div id="image-modal" class="modal task-image-modal">
                            <div class="modal-background"></div>
                            <div class="modal-content has-text-centered">
                                <a id="link-image" href="" target="_blank">
                                    <img src="{{ task.image.url }}" id="preview-image" class="mt-1 task-image-preview" alt="Preview" />
                                </a>
                            </div>
                            <button class="modal-close is-large" aria-label="close"></button>
                        </div>
                    {% else %}
                        <span class="has-text-grey">Нет файлов</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-calendar"></i>
                    {% translate 'Дата' %}
                </div>
                <div class="task-info-value">
                    {% if task.deadline %}
                        <span class="tag is-warning is-light">{{ task.deadline|date:"d.m.Y H:i" }}</span>
                    {% else %}
                        <span class="has-text-grey">Бессрочно</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-tasks"></i>
                    {% translate 'Чек-лист' %}
                </div>
                <div class="task-info-value">
                    {% if checklist_items %}
                        {% if total_checklist > 0 %}
                            <div class="checklist-progress-container" id="checklist-progress-block" hx-get="{% url 'tasks:checklist_progress' task.pk %}" hx-trigger="load, checklist-updated from:body">
                                <div class="checklist-progress-bar">
                                    <div class="checklist-progress-fill" data-progress="{{ progress_checklist }}"></div>
                                </div>
                                <div class="checklist-progress-text">{{ done_checklist }} / {{ total_checklist }} выполнено</div>
                            </div>
                        {% endif %}
                        <ul class="list-group">
                            {% for item in checklist_items %}
                                {% include 'tasks/checklist_item.html' with item=item %}
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="has-text-grey">Чеклист пуст.</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="task-info-row">
                <div class="task-info-label">
                    <i class="fa fa-calendar-plus"></i>
                    {% translate 'Дата создания' %}
                </div>
                <div class="task-info-value">
                    <span class="tag is-light">{{ task.created_at|date:'d.m.Y H:i' }}</span>
                </div>
            </div>
            
            <div class="task-action-buttons">
                <a class="task-action-button primary" href="{% url 'tasks:list' %}">
                    <i class="fa fa-list"></i>
                    Список задач
                </a>
                <a class="task-action-button warning {% if task.state == 'done' %}disabled{% endif %}" href="{% url 'tasks:update' task.slug %}">
                    <i class="fa fa-edit"></i>
                    Изменить
                </a>
                <a class="task-action-button danger" href="{% url 'tasks:delete_task' task.slug %}">
                    <i class="fa fa-trash"></i>
                    Удалить
                </a>
            </div>
        </div>
    </div>
    
    <!-- Секция комментариев -->
    <div class="comments-section-wrapper">
        {% if user == task.author or user == task.executor or not task.executor %}
            <div class="comment-form-container">
                <h3 class="comment-form-title">
                    <i class="fa fa-comment"></i>
                    Добавить комментарий
                </h3>
                <form hx-post="{% url 'tasks:comment_create' task.slug %}"
                      hx-target="#comments-container"
                      hx-swap="innerHTML"
                      hx-on::after-request="if(event.detail.successful) this.reset()">
                    {% csrf_token %}
                    <div class="field">
                        <div class="control">
                            {{ comment_form.content }}
                        </div>
                    </div>
                    <div class="field">
                        <div class="control">
                            <button type="submit" class="button is-primary">
                                <i class="fa fa-paper-plane"></i>
                                Отправить комментарий
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        {% endif %}
        
        <div class="comments-section">
            <h3 class="comments-title">
                <i class="fa fa-comments"></i>
                Комментарии ({{ comments.paginator.count }})
            </h3>
            
            <div id="comments-container">
                {% if comments %}
                    {% for comment in comments %}
                        {% include 'tasks/_comment.html' with comment=comment %}
                    {% endfor %}
                {% else %}
                    <div class="no-comments">
                        <p class="has-text-grey">Пока нет комментариев. Будьте первым!</p>
                    </div>
                {% endif %}
            </div>
            
            {% if comments.has_other_pages %}
                <nav class="pagination is-centered" role="navigation" aria-label="pagination">
                    {% if comments.has_previous %}
                        <a class="pagination-previous" 
                           hx-get="{% url 'tasks:comments_list' task.slug %}?page={{ comments.previous_page_number }}"
                           hx-target="#comments-container"
                           hx-swap="innerHTML">
                            Предыдущая
                        </a>
                    {% endif %}
                    
                    {% if comments.has_next %}
                        <a class="pagination-next"
                           hx-get="{% url 'tasks:comments_list' task.slug %}?page={{ comments.next_page_number }}"
                           hx-target="#comments-container"
                           hx-swap="innerHTML">
                            Следующая
                        </a>
                    {% endif %}
                    
                    <ul class="pagination-list">
                        {% for num in comments.paginator.page_range %}
                            {% if comments.number == num %}
                                <li><span class="pagination-link is-current">{{ num }}</span></li>
                            {% elif num > comments.number|add:'-3' and num < comments.number|add:'3' %}
                                <li>
                                    <a class="pagination-link"
                                       hx-get="{% url 'tasks:comments_list' task.slug %}?page={{ num }}"
                                       hx-target="#comments-container"
                                       hx-swap="innerHTML">
                                        {{ num }}
                                    </a>
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </nav>
            {% endif %}
        </div>
    </div>
    
    <script>
        document.body.addEventListener('updateCommentsCount', function(event) {
            const count = event.detail.count;
            const titleElement = document.querySelector('.comments-title');
            if (titleElement) {
                titleElement.innerHTML = `<i class="fa fa-comments"></i> Комментарии (${count})`;
            }
        });
    </script>
    

{% endblock %}
    
